name: ci-deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (service account JSON)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and push Docker image
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          IMAGE=us.gcr.io/${{ secrets.GCP_PROJECT_ID }}/goapp:${{ env.IMAGE_TAG }}
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="container_image=us.gcr.io/${{ secrets.GCP_PROJECT_ID }}/goapp:${{ env.IMAGE_TAG }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Export Terraform outputs to env
        working-directory: ./terraform
        run: |
          outputs=$(terraform output -json 2>/dev/null || echo "{}")
          echo "$outputs" > tf_outputs.json

          CLUSTER_NAME=$(python3 - <<'PY'
import json
j = json.load(open('tf_outputs.json'))
v = j.get('cluster_name')
print(v.get('value', '') if isinstance(v, dict) else '')
PY
)

          CLUSTER_LOCATION=$(python3 - <<'PY'
import json
j = json.load(open('tf_outputs.json'))
v = j.get('cluster_location') or j.get('cluster_zone') or j.get('cluster_region')
print(v.get('value', '') if isinstance(v, dict) else '')
PY
)

          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          echo "CLUSTER_LOCATION=$CLUSTER_LOCATION" >> $GITHUB_ENV

      - name: Get GKE credentials (if cluster info available)
        if: ${{ env.CLUSTER_NAME != '' && env.CLUSTER_LOCATION != '' }}
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud container clusters get-credentials "$CLUSTER_NAME" --zone "$CLUSTER_LOCATION" --project "${{ secrets.GCP_PROJECT_ID }}"
          kubectl get nodes --no-headers
