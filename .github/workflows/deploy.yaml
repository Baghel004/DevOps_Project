name: ci-deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (service account JSON)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build and push Docker image
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          IMAGE=us.gcr.io/${{ secrets.GCP_PROJECT_ID }}/goapp:${{ env.IMAGE_TAG }}
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="container_image=us.gcr.io/${{ secrets.GCP_PROJECT_ID }}/goapp:${{ env.IMAGE_TAG }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Export Terraform outputs to env (no-python, uses jq)
        working-directory: ./terraform
        run: |
          # ensure jq is available
          apt-get update -y
          apt-get install -y jq

          # capture outputs (safe if no outputs present)
          outputs=$(terraform output -json 2>/dev/null || echo "{}")
          echo "$outputs" > tf_outputs.json

          # extract cluster name (terraform outputs are objects like { "value": ... })
          CLUSTER_NAME=$(jq -r '.cluster_name.value // empty' tf_outputs.json || true)

          # extract cluster location: try cluster_location, then cluster_zone, then cluster_region
          CLUSTER_LOCATION=$(jq -r '(.cluster_location.value // .cluster_zone.value // .cluster_region.value) // empty' tf_outputs.json || true)

          # Export to GITHUB_ENV so subsequent steps can use them
          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_ENV
          echo "CLUSTER_LOCATION=$CLUSTER_LOCATION" >> $GITHUB_ENV

      - name: Get GKE credentials (if cluster info available)
        if: ${{ env.CLUSTER_NAME != '' && env.CLUSTER_LOCATION != '' }}
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          gcloud container clusters get-credentials "$CLUSTER_NAME" --zone "$CLUSTER_LOCATION" --project "${{ secrets.GCP_PROJECT_ID }}"
          kubectl get nodes --no-headers
